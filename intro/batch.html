

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Batch class &#8212; Dataset 0.3.0 documentation</title>
    <link rel="stylesheet" href="../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Batch class for handling images" href="images_batch.html" />
    <link rel="prev" title="Dataset" href="dataset.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="images_batch.html" title="Batch class for handling images"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="dataset.html" title="Dataset"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Dataset 0.3.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="classes.html" accesskey="U">Classes and capabilities</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Batch class</a><ul>
<li><a class="reference internal" href="#index">Index</a></li>
<li><a class="reference internal" href="#data">Data</a><ul>
<li><a class="reference internal" href="#preloaded">preloaded</a></li>
<li><a class="reference internal" href="#components">components</a></li>
</ul>
</li>
<li><a class="reference internal" href="#action-methods">Action methods</a></li>
<li><a class="reference internal" href="#models-and-model-based-actions">Models and model-based actions</a></li>
<li><a class="reference internal" href="#running-methods-in-parallel">Running methods in parallel</a></li>
<li><a class="reference internal" href="#writing-your-own-batch">Writing your own Batch</a><ul>
<li><a class="reference internal" href="#constructor-should-include-args-and-kwargs">Constructor should include <cite>*args</cite> and <cite>*kwargs</cite></a></li>
<li><a class="reference internal" href="#don-t-load-data-in-the-constructor">Don’t load data in the constructor</a></li>
<li><a class="reference internal" href="#store-your-data-in-data-property">Store your data in <cite>_data</cite> property</a></li>
<li><a class="reference internal" href="#use-components">Use components</a></li>
<li><a class="reference internal" href="#make-actions-whenever-possible">Make <cite>actions</cite> whenever possible</a></li>
<li><a class="reference internal" href="#parallelize-everyting-you-can">Parallelize everyting you can</a></li>
<li><a class="reference internal" href="#define-load-and-dump-action-methods">Define <cite>load</cite> and <cite>dump</cite> action-methods</a></li>
<li><a class="reference internal" href="#make-all-i-o-in-async-methods">Make all I/O in <cite>async</cite> methods</a></li>
<li><a class="reference internal" href="#make-all-i-o-in-async-methods-even-if-there-is-nothing-to-parallelize">Make all I/O in <cite>async</cite> methods even if there is nothing to parallelize</a><ul>
<li><a class="reference internal" href="#api">API</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="dataset.html"
                        title="previous chapter">Dataset</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="images_batch.html"
                        title="next chapter">Batch class for handling images</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/intro/batch.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="batch-class">
<h1>Batch class<a class="headerlink" href="#batch-class" title="Permalink to this headline">¶</a></h1>
<p>Batch class holds the data and contains processing functions.
Normally, you never create batch instances, as they are created in the <cite>Dataset</cite> or <cite>Pipeline</cite> batch generators.</p>
<div class="section" id="index">
<h2>Index<a class="headerlink" href="#index" title="Permalink to this headline">¶</a></h2>
<p><cite>Batch</cite> class stores the <a class="reference internal" href="index.html"><span class="doc">index</span></a> of all data items which belong to the batch. You can access the index through <cite>self.index</cite> (it is an instance of <a class="reference internal" href="index.html#datasetindex"><span class="std std-ref">DatasetIndex</span></a> or its child). The sequence of indices is also available as <cite>self.indices</cite>.</p>
</div>
<div class="section" id="data">
<h2>Data<a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h2>
<p>The base <a class="reference internal" href="../api/dataset.batch.html#dataset.Batch" title="dataset.Batch"><code class="xref py py-class docutils literal notranslate"><span class="pre">Batch</span></code></a> class has a private property <code class="xref py py-attr docutils literal notranslate"><span class="pre">_data</span></code> which you can use to store your data in. Just call <a class="reference internal" href="../api/dataset.batch.html#dataset.Batch.put_into_data" title="dataset.Batch.put_into_data"><code class="xref py py-func docutils literal notranslate"><span class="pre">put_into_data()</span></code></a>. After that, you can access data through a public property <a class="reference internal" href="../api/dataset.batch.html#dataset.Batch.data" title="dataset.Batch.data"><code class="xref py py-attr docutils literal notranslate"><span class="pre">data</span></code></a>. This approach allows to conceal an internal data structure and provides for a more convenient and (perhaps) more stable public interface to access the data.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">some_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_into_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="n">some_data</span><span class="p">)</span>
</pre></div>
</div>
<p>If your batch has <a class="reference internal" href="#components">components</a>, you might put only a few components:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">some_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_into_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="n">some_data</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;comp1&#39;</span><span class="p">,</span> <span class="s1">&#39;comp2&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Even though this is just a convention and you are not obliged to use it, many predefined methods follow it, thus making your life a bit easier.</p>
<div class="section" id="preloaded">
<h3>preloaded<a class="headerlink" href="#preloaded" title="Permalink to this headline">¶</a></h3>
<p>To fill in the batch with preloaded data you might initialize it with <cite>preloaded</cite> argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="n">MyBatch</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">preloaded</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>So <a class="reference internal" href="../api/dataset.batch.html#dataset.Batch.data" title="dataset.Batch.data"><code class="xref py py-attr docutils literal notranslate"><span class="pre">data</span></code></a> will contain data right after batch creation and you don’t need to call <a class="reference internal" href="../api/dataset.batch.html#dataset.Batch.load" title="dataset.Batch.load"><code class="xref py py-func docutils literal notranslate"><span class="pre">load()</span></code></a> action.</p>
<p>You also might initialize the whole dataset:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">batch_class</span><span class="o">=</span><span class="n">Mybatch</span><span class="p">,</span> <span class="n">preloaded</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>Thus <a class="reference internal" href="../api/dataset.dataset.html#dataset.Dataset.gen_batch" title="dataset.Dataset.gen_batch"><code class="xref py py-func docutils literal notranslate"><span class="pre">gen_batch()</span></code></a> and <a class="reference internal" href="../api/dataset.dataset.html#dataset.Dataset.next_batch" title="dataset.Dataset.next_batch"><code class="xref py py-func docutils literal notranslate"><span class="pre">next_batch()</span></code></a> will create batches that contain preloaded data.</p>
<p>To put it simply, <cite>preloaded=data</cite> is roughly equivalent to <cite>batch.load(data, fmt=None)</cite>.</p>
</div>
<div class="section" id="components">
<span id="id1"></span><h3>components<a class="headerlink" href="#components" title="Permalink to this headline">¶</a></h3>
<p>Not infrequently, the batch stores a more complex data structures, e.g. features and labels or images, masks, bounding boxes and labels. To work with these you might employ data components. Just define a property as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="n">components</span> <span class="o">=</span> <span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span>
</pre></div>
</div>
<p>And this allows you to address components to read and write data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">image_5</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="n">batch</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_image</span>
<span class="n">label_k</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">labels</span>
<span class="n">batch</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">new_masks</span>
</pre></div>
</div>
<p>Numerous methods take <code class="docutils literal notranslate"><span class="pre">components</span></code> parameters which allows to specify which components will be affected by the method.
For instance, you can load components from different sources, or save components to disk, or apply some transformations
(like resizing, zooming or rotating).</p>
</div>
</div>
<div class="section" id="action-methods">
<h2>Action methods<a class="headerlink" href="#action-methods" title="Permalink to this headline">¶</a></h2>
<p><cite>Action</cite>-methods form a public API of the batch class which is available in <a class="reference internal" href="pipeline.html"><span class="doc">pipelines</span></a>. If you operate directly with the batch class instances, you don’t need <cite>action</cite>-methods. However, pipelines provide the most convenient interface to process the whole dataset and to separate data processing steps and model training / validation cycles.</p>
<p>In order to convert a batch class method to an action you add <cite>&#64;action</cite> decorator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dataset</span> <span class="k">import</span> <span class="n">Batch</span><span class="p">,</span> <span class="n">action</span>

<span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="nd">@action</span>
    <span class="k">def</span> <span class="nf">some_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># process your data</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
<p>Take into account that an <cite>action</cite>-method should return an instance of some <cite>Batch</cite>-class: the very same one or some other class.
If an <cite>action</cite> changes the instance’s data directly, it may simply return <cite>self</cite>.</p>
</div>
<div class="section" id="models-and-model-based-actions">
<h2>Models and model-based actions<a class="headerlink" href="#models-and-model-based-actions" title="Permalink to this headline">¶</a></h2>
<p>To get access to a model just call <a class="reference internal" href="../api/dataset.batch.html#dataset.Batch.get_model_by_name" title="dataset.Batch.get_model_by_name"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_model_by_name()</span></code></a> within actions or ordinary batch class methods.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="nd">@action</span>
    <span class="k">def</span> <span class="nf">train_my_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">):</span>
        <span class="n">my_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_by_name</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>For more details see <a class="reference internal" href="models.html"><span class="doc">Working with models</span></a>.</p>
</div>
<div class="section" id="running-methods-in-parallel">
<h2>Running methods in parallel<a class="headerlink" href="#running-methods-in-parallel" title="Permalink to this headline">¶</a></h2>
<p>As a batch can be quite large it might make sense to parallel the computations. And it is pretty easy to do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dataset</span> <span class="k">import</span> <span class="n">Batch</span><span class="p">,</span> <span class="n">inbatch_parallel</span><span class="p">,</span> <span class="n">action</span>

<span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="nd">@action</span>
    <span class="nd">@inbatch_parallel</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="s1">&#39;_init_fn&#39;</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="s1">&#39;_post_fn&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;threads&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">some_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span>
        <span class="c1"># process just one item</span>
        <span class="k">return</span> <span class="n">some_value</span>
</pre></div>
</div>
<p>For further details see <a class="reference internal" href="parallel.html"><span class="doc">how to make parallel actions</span></a>.</p>
</div>
<div class="section" id="writing-your-own-batch">
<h2>Writing your own Batch<a class="headerlink" href="#writing-your-own-batch" title="Permalink to this headline">¶</a></h2>
<div class="section" id="constructor-should-include-args-and-kwargs">
<h3>Constructor should include <cite>*args</cite> and <cite>*kwargs</cite><a class="headerlink" href="#constructor-should-include-args-and-kwargs" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">your_param1</span><span class="p">,</span> <span class="n">your_param2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="c1"># process your data</span>
</pre></div>
</div>
<p>It is not so important if you are extremely careful when calling batch generators and parallelizing actions, so you are absolutly sure that a batch cannot get unexpected arguments.
But usually it is just easier to add <cite>*args</cite> and <cite>*kwargs</cite> and have a guarantee that your program will not break or hang up (as it most likely will do if you do batch prefetching with multiprocessing).</p>
</div>
<div class="section" id="don-t-load-data-in-the-constructor">
<h3>Don’t load data in the constructor<a class="headerlink" href="#don-t-load-data-in-the-constructor" title="Permalink to this headline">¶</a></h3>
<p>The constructor should just intialize properties.
<cite>Action</cite>-method <cite>load</cite> is the best place for reading data from files or other sources.</p>
<p>So DON’T do this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">your_param1</span><span class="p">,</span> <span class="n">your_param2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</pre></div>
</div>
<p>Instead DO that:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">your_param1</span><span class="p">,</span> <span class="n">your_param2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="o">...</span>

    <span class="nd">@action</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># load data from source</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_into_data</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
</div>
<div class="section" id="store-your-data-in-data-property">
<h3>Store your data in <cite>_data</cite> property<a class="headerlink" href="#store-your-data-in-data-property" title="Permalink to this headline">¶</a></h3>
<p>It is just a convenient convention which makes your life more consistent.</p>
</div>
<div class="section" id="use-components">
<h3>Use components<a class="headerlink" href="#use-components" title="Permalink to this headline">¶</a></h3>
<p>Quite often a batch contains several semantic data parts, like images and labels, or transactions and ther scores.
For a more flexible data processing and covenient actions create data components. It takes just one line of code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="n">components</span> <span class="o">=</span> <span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span>
</pre></div>
</div>
<p>See above <a class="reference external" href="#components">for more details about components</a>.</p>
</div>
<div class="section" id="make-actions-whenever-possible">
<h3>Make <cite>actions</cite> whenever possible<a class="headerlink" href="#make-actions-whenever-possible" title="Permalink to this headline">¶</a></h3>
<p>If you create some method transforming batch data, you might want to call it as a step in a <a class="reference internal" href="pipeline.html"><span class="doc">Pipeline</span></a> processing the whole dataset.
So make it an <cite>action</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="nd">@action</span>
    <span class="k">def</span> <span class="nf">change_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span>
        <span class="c1"># process your data</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
<p><cite>Actions</cite> should return an instance of some batch class.</p>
</div>
<div class="section" id="parallelize-everyting-you-can">
<h3>Parallelize everyting you can<a class="headerlink" href="#parallelize-everyting-you-can" title="Permalink to this headline">¶</a></h3>
<p>If you want a really fast data processing you can’t do without <cite>numba</cite> or <cite>cython</cite>.
And don’t forget about input/output operations.
For more details see <a class="reference internal" href="parallel.html"><span class="doc">how to make a parallel actions</span></a>.</p>
</div>
<div class="section" id="define-load-and-dump-action-methods">
<h3>Define <cite>load</cite> and <cite>dump</cite> action-methods<a class="headerlink" href="#define-load-and-dump-action-methods" title="Permalink to this headline">¶</a></h3>
<p><cite>load</cite> and <cite>dump</cite> allows for a convenient and managable data flow.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="nd">@action</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;raw&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_into_data</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="c1"># load from a raw file</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;blosc&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_into_data</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="c1"># load from a blosc file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@action</span>
    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;raw&#39;</span><span class="p">:</span>
            <span class="c1"># write self.data to a raw file</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;blosc&#39;</span><span class="p">:</span>
            <span class="c1"># write self.data to a blosc file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dum</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
<p>This lets you create explicit pipeline workflows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span>
   <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/some/path&#39;</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">)</span>
   <span class="o">.</span><span class="n">some_action</span><span class="p">(</span><span class="n">param1</span><span class="p">)</span>
   <span class="o">.</span><span class="n">other_action</span><span class="p">(</span><span class="n">param2</span><span class="p">)</span>
   <span class="o">.</span><span class="n">one_more_action</span><span class="p">()</span>
   <span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;/other/path&#39;</span><span class="p">,</span> <span class="s1">&#39;blosc&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="make-all-i-o-in-async-methods">
<h3>Make all I/O in <cite>async</cite> methods<a class="headerlink" href="#make-all-i-o-in-async-methods" title="Permalink to this headline">¶</a></h3>
<p>This is extremely important if you read batch data from many files.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="nd">@action</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;raw&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_into_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_raw</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;blosc&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_into_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_blosc</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown format &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@inbatch_parallel</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="s1">&#39;_init_io&#39;</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="s1">&#39;_post_io&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;async&#39;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_load_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">full_path</span><span class="p">):</span>
        <span class="c1"># load one data item from a raw format file</span>
        <span class="k">return</span> <span class="n">loaded_item</span>

    <span class="k">def</span> <span class="nf">_init_io</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">item_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_fullpath</span><span class="p">(</span><span class="n">item_id</span><span class="p">)]</span> <span class="k">for</span> <span class="n">item_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_post_io</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_res</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">any_action_failed</span><span class="p">(</span><span class="n">all_res</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Could not load data.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_into_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_res</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
</div>
<div class="section" id="make-all-i-o-in-async-methods-even-if-there-is-nothing-to-parallelize">
<h3>Make all I/O in <cite>async</cite> methods even if there is nothing to parallelize<a class="headerlink" href="#make-all-i-o-in-async-methods-even-if-there-is-nothing-to-parallelize" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="nd">@inbatch_parallel</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="s1">&#39;run_once&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;async&#39;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">read_some_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">):</span>
        <span class="o">...</span>
<span class="o">...</span>
<span class="n">some_pipeline</span>
    <span class="o">.</span><span class="n">do_whatever_you_want</span><span class="p">()</span>
    <span class="o">.</span><span class="n">read_some_data</span><span class="p">(</span><span class="s1">&#39;/some/path&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">do_something_else</span><span class="p">()</span>
</pre></div>
</div>
<p>Init-function <cite>run_once</cite> runs the decorated method once (so no parallelism whatsoever).
Besides, the methods does not receive any additional arguments, only those passed to it directly.
However, an <cite>action</cite> defined as asynchronous will be waited for.
You may define your own <cite>post</cite>-method in order to check the result and process the exceptions if they arise.</p>
<div class="section" id="api">
<h4>API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h4>
<p>See <a class="reference internal" href="../api/dataset.batch.html"><span class="doc">Batch API</span></a>.</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="images_batch.html" title="Batch class for handling images"
             >next</a> |</li>
        <li class="right" >
          <a href="dataset.html" title="Dataset"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Dataset 0.3.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="classes.html" >Classes and capabilities</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Analysis Center.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>